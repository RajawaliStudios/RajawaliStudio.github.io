<!doctype html>

<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dino — Full Color Challenge (Final)</title>
  <style>
    :root{--bg1:#071029;--bg2:#051224;--glass:rgba(255,255,255,0.03);--accent:#7c5cff;--accent2:#00f2fe;--good:#22c55e}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Arial,Helvetica,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6eef8}
    #app{min-height:100vh;display:flex;flex-direction:column;align-items:center;gap:14px;padding:22px}
    .panel{width:100%;max-width:980px;padding:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;box-shadow:0 12px 40px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03)}
    .hud{display:flex;justify-content:space-between;align-items:center;color:#cfe6ff;gap:10px}
    .leftHUD,.rightHUD{display:flex;gap:10px;align-items:center}
    .scoreBox{background:linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));padding:8px 14px;border-radius:12px;font-weight:700;display:flex;gap:18px;align-items:center}
    button{background:transparent;color:var(--accent);border:1px solid rgba(124,92,255,0.18);padding:8px 12px;border-radius:10px;font-weight:700;cursor:pointer}
    button.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#06202a;border:none}
    canvas{background:transparent;border-radius:12px;box-shadow:0 10px 40px rgba(2,6,23,0.6);width:100%;max-width:980px;aspect-ratio:16/9}
    .meters{display:flex;gap:10px;align-items:center}
    .bar{width:160px;height:12px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden}
    .bar>i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),var(--accent2));width:60%}
    .hearts{display:flex;gap:6px}
    .leader{margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,0.02)}
    input[type=text],input[type=email],input[type=password]{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px 10px;border-radius:8px;color:#e6eef8}
    /* Fullscreen login overlay */
    .overlay{position:fixed;inset:0;background:linear-gradient(180deg, rgba(2,6,23,0.6), rgba(2,6,23,0.8));backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:60}
    .card{width:100%;max-width:520px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:26px;box-shadow:0 14px 50px rgba(2,6,23,0.7);border:1px solid rgba(255,255,255,0.03)}
    .card h2{margin:0 0 8px 0}
    .row{display:flex;gap:8px}
    .muted{color:#9fb8d6;font-size:13px}
    .topline{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .small{font-size:13px}
    footer{margin-top:10px;color:#9fb8d6;font-size:13px}
    @media (max-width:600px){.card{margin:12px}} 
  </style>
</head>
<body>
  <div id="app">
    <div class="panel hud">
      <div class="leftHUD">
        <div class="scoreBox">Player: <span id="playerName">—</span></div>
        <div class="scoreBox">Score: <span id="score">0</span></div>
        <div class="scoreBox">High: <span id="high">0</span></div>
        <div class="meters"><div title="Energy" style="display:flex;align-items:center;gap:6px">⚡<div class="bar"><i id="energyFill"></i></div></div><div title="Health" style="display:flex;align-items:center;gap:6px">❤️<div class="hearts" id="hearts"></div></div></div>
      </div>
      <div class="rightHUD">
        <button id="startBtn" class="primary">Start / Restart</button>
        <button id="logoutBtn" class="ghost">Logout</button>
        <button id="muteBtn" class="ghost">Mute</button>
        <button id="pauseBtn" class="ghost">Pause</button>
      </div>
    </div><canvas id="game"></canvas>

<div class="panel leader">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div><strong>Leaderboard Global</strong> — Top 10</div>
    <div style="display:flex;gap:8px;align-items:center">
      <input id="nameInput" type="text" placeholder="Nama (opsional)" maxlength="20" />
      <button id="submitScoreBtn">Submit Score</button>
    </div>
  </div>
  <ol id="leaderList" style="margin-top:8px;padding-left:18px"></ol>
  <div class="muted">Leaderboard tersimpan online di Firebase Realtime Database.</div>
</div>

  </div>  <!-- Fullscreen Login / Signup overlay -->  <div id="overlay" class="overlay" aria-hidden="true">
    <div class="card">
      <div class="topline"><h2>Masuk ke Dino — Full Color</h2><div class="muted small">Login diperlukan untuk leaderboard</div></div>
      <div id="authForms">
        <div style="display:flex;gap:10px;margin-bottom:10px">
          <button id="showLogin" class="primary">Login</button>
          <button id="showSignup" class="ghost">Sign Up</button>
        </div><form id="loginForm" style="display:block;" onsubmit="return false">
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="loginEmail" type="email" placeholder="Email" required />
        <input id="loginPassword" type="password" placeholder="Password" required />
        <div style="display:flex;gap:8px;align-items:center">
          <button id="loginBtn" class="primary">Masuk</button>
          <button id="guestBtn" class="ghost">Main sebagai Guest</button>
        </div>
      </div>
    </form>

    <form id="signupForm" style="display:none;" onsubmit="return false">
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="signupName" type="text" placeholder="Nama tampil (opsional)" maxlength="20" />
        <input id="signupEmail" type="email" placeholder="Email" required />
        <input id="signupPassword" type="password" placeholder="Password (min 6)" required />
        <div style="display:flex;gap:8px;align-items:center">
          <button id="signupBtn" class="primary">Daftar</button>
        </div>
      </div>
    </form>

    <div id="authMsg" class="muted small" style="margin-top:10px"></div>
  </div>
  <footer>Dengan masuk, skor kamu akan tersimpan di leaderboard online.</footer>
</div>

  </div>  <script type="module">
    // Firebase imports (script-tag style, v12.5.0 used by your project)
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";
    import { getDatabase, ref, push, query, orderByChild, limitToLast, onValue } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";

    // --- Paste your firebaseConfig here (from the snippet you provided) ---
    const firebaseConfig = {
      apiKey: "AIzaSyB_FiLNuz6WJiszmx5GSVfE2YVT9tJK7ck",
      authDomain: "dino-games-437fc.firebaseapp.com",
      projectId: "dino-games-437fc",
      storageBucket: "dino-games-437fc.firebasestorage.app",
      messagingSenderId: "360800363471",
      appId: "1:360800363471:web:08eb67c758fa913714a8ba",
      measurementId: "G-7NMJHY5LW5",
      databaseURL: "https://dino-games-437fc-default-rtdb.firebaseio.com"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // DOM refs
    const overlay = document.getElementById('overlay');
    const playerNameEl = document.getElementById('playerName');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');
    const showLogin = document.getElementById('showLogin');
    const showSignup = document.getElementById('showSignup');
    const loginBtn = document.getElementById('loginBtn');
    const signupBtn = document.getElementById('signupBtn');
    const guestBtn = document.getElementById('guestBtn');
    const authMsg = document.getElementById('authMsg');
    const logoutBtn = document.getElementById('logoutBtn');
    const nameInput = document.getElementById('nameInput');
    const submitScoreBtn = document.getElementById('submitScoreBtn');
    const leaderList = document.getElementById('leaderList');

    // show/hide forms
    showLogin.addEventListener('click', ()=>{ loginForm.style.display='block'; signupForm.style.display='none'; authMsg.textContent=''; });
    showSignup.addEventListener('click', ()=>{ loginForm.style.display='none'; signupForm.style.display='block'; authMsg.textContent=''; });

    // Auth handlers
    loginBtn.addEventListener('click', async ()=>{
      const email = document.getElementById('loginEmail').value.trim();
      const pw = document.getElementById('loginPassword').value;
      try{ await signInWithEmailAndPassword(auth, email, pw); authMsg.textContent='Login berhasil'; }
      catch(e){ authMsg.textContent = 'Login gagal: ' + (e.message || e.code); }
    });

    signupBtn.addEventListener('click', async ()=>{
      const name = document.getElementById('signupName').value.trim();
      const email = document.getElementById('signupEmail').value.trim();
      const pw = document.getElementById('signupPassword').value;
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pw);
        if(name){ await updateProfile(cred.user, {displayName: name}); }
        authMsg.textContent = 'Akun dibuat. Sedang masuk...';
      } catch(e){ authMsg.textContent = 'Daftar gagal: ' + (e.message || e.code); }
    });

    guestBtn.addEventListener('click', ()=>{
      // Create a temporary guest name (not stored in Firebase Auth) and hide overlay
      const guestName = 'Guest' + Math.floor(Math.random()*9000 + 1000);
      window.__PLAYER = { uid: 'guest-' + Date.now(), displayName: guestName, isGuest: true };
      onLogin(window.__PLAYER);
    });

    logoutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); localStorage.removeItem('playerName'); location.reload(); }catch(e){ console.warn(e); } });

    onAuthStateChanged(auth, user => {
      if(user){ // logged in
        window.__PLAYER = { uid: user.uid, displayName: user.displayName || user.email, isGuest: false };
        localStorage.setItem('playerName', window.__PLAYER.displayName);
        onLogin(window.__PLAYER);
      } else {
        // if we have a stored playerName and it's guest-like, use it? otherwise show overlay
        const saved = localStorage.getItem('playerName');
        if(saved){ playerNameEl.textContent = saved; }
        // show overlay (force login)
        overlay.setAttribute('aria-hidden','false'); overlay.style.display = 'flex';
      }
    });

    function onLogin(player){ overlay.setAttribute('aria-hidden','true'); overlay.style.display = 'none'; playerNameEl.textContent = player.displayName; window.PLAYER = player; // expose for other code
      // fetch leaderboard now
      fetchLeaderboard();
    }

    // --- Leaderboard functions ---
    async function submitScoreToFirebase(name, score){
      try{
        const scoresRef = ref(db, 'scores');
        await push(scoresRef, { user: name, score: score, date: new Date().toISOString(), uid: (window.PLAYER && window.PLAYER.uid) || null });
        fetchLeaderboard();
      } catch(e){ console.warn('submit failed', e); }
    }

    function fetchLeaderboard(){
      // get top 10 by score descending: order by 'score' and limitToLast(10)
      const q = query(ref(db, 'scores'), orderByChild('score'), limitToLast(10));
      onValue(q, snap => {
        const list = [];
        snap.forEach(child => { list.push(child.val()); });
        // sort desc
        list.sort((a,b)=>b.score - a.score);
        renderLeaderboard(list);
      }, err=>{ console.warn('leader fetch', err); });
    }

    function renderLeaderboard(rows){ leaderList.innerHTML=''; for(const r of rows){ const li = document.createElement('li'); const d = new Date(r.date); li.textContent = (r.user || 'Anon') + ' — ' + r.score + ' (' + d.toLocaleString() + ')'; leaderList.appendChild(li); } }

    submitScoreBtn.addEventListener('click', ()=>{
      const name = (nameInput.value.trim() || (window.PLAYER && window.PLAYER.displayName) || 'Anon');
      const sc = Math.floor(window.GAME && window.GAME.score || 0);
      // require auth for writing: if guest => show message
      if(window.PLAYER && window.PLAYER.isGuest){ // guest can't write to DB under our rules
        alert('Login dulu untuk submit skor ke leaderboard.');
        return;
      }
      submitScoreToFirebase(name, sc);
    });

    // -------------------------------------------------
    // Game code (module scope) — adapted from previous version
    // -------------------------------------------------
    const canvas = document.getElementById('game'); const ctx = canvas.getContext('2d');
    function resize(){ const ratio = 16/9; const width = Math.min(window.innerWidth - 40, 980); canvas.width = Math.floor(width * devicePixelRatio); canvas.height = Math.floor((width/ratio) * devicePixelRatio); canvas.style.width = width + 'px'; canvas.style.height = (width/ratio) + 'px'; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
    window.addEventListener('resize', resize); resize();

    const scoreEl = document.getElementById('score'); const highEl = document.getElementById('high'); const startBtn = document.getElementById('startBtn'); const muteBtn = document.getElementById('muteBtn'); const pauseBtn = document.getElementById('pauseBtn'); const energyFill = document.getElementById('energyFill'); const heartsEl = document.getElementById('hearts');

    let running=false, paused=false, muted=false, lastTime=0; let score=0, high = Number(localStorage.getItem('dino_high')||0); highEl.textContent = high;
    const GRAV=1400, groundY=160;
    const dino = { x:60, y:0, w:48, h:48, vy:0, onGround:false, duck:false, jumps:0 };
    const maxJumps = 2;
    let obstacles = [], powerUps = [], particles = [], clouds = []; let spawnTimer=0, speed=420, difficulty=1; let shield=0, rainbow=0; let energy=100; let health=3;

    const AudioCtx = window.AudioContext || window.webkitAudioContext; const audioCtx = AudioCtx ? new AudioCtx() : null; let musicStarted=false; let musicNode=null;

    function startProceduralMusic(){ if(!audioCtx || musicStarted || muted) return; musicStarted=true; const master = audioCtx.createGain(); master.gain.value = 0.45; master.connect(audioCtx.destination); const bpm=110; const beat = 60/bpm; const bass = audioCtx.createOscillator(); bass.type='sawtooth'; const bassGain = audioCtx.createGain(); bassGain.gain.value=0.0; bass.connect(bassGain); bassGain.connect(master); const lp = audioCtx.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=800; bassGain.connect(lp); lp.connect(master); const hatGain = audioCtx.createGain(); hatGain.gain.value=0.0; hatGain.connect(master); const lead = audioCtx.createOscillator(); lead.type='triangle'; const leadGain = audioCtx.createGain(); leadGain.gain.value=0.0; lead.connect(leadGain); leadGain.connect(master); bass.start(); lead.start(); let startTime = audioCtx.currentTime + 0.02; function schedule(time){ for(let i=0;i<4;i++){ const t = time + i*beat; const notes=[55,82.4,65.4,73.4]; bass.frequency.setValueAtTime(notes[i], t); bassGain.gain.setValueAtTime(0.12, t); bassGain.gain.exponentialRampToValueAtTime(0.001, t+beat*0.9); if(i%2===0){ lead.frequency.setValueAtTime(notes[i]*2.5, t+0.05); leadGain.gain.setValueAtTime(0.06, t+0.05); leadGain.gain.exponentialRampToValueAtTime(0.0001, t+beat*0.5); } const bufferSize = audioCtx.sampleRate * 0.02; const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate); const data = buffer.getChannelData(0); for(let j=0;j<data.length;j++) data[j] = (Math.random()*2-1) * Math.exp(-j/(bufferSize/6)); const src = audioCtx.createBufferSource(); src.buffer = buffer; src.connect(hatGain); hatGain.gain.setValueAtTime(0.06, t+0.02); src.start(t+0.02); } musicNode = setTimeout(()=>{ schedule(time + 4*beat); }, (4*beat - 0.05) * 1000); }
    schedule(startTime); startProceduralMusic.stop = ()=>{ try{ bass.stop(); lead.stop(); }catch(e){} if(musicNode) clearTimeout(musicNode); musicStarted=false; } }
    function stopProceduralMusic(){ if(startProceduralMusic.stop) startProceduralMusic.stop(); }

    function sfx(type){ if(muted||!audioCtx) return; const now = audioCtx.currentTime; if(type==='jump'){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(900, now); g.gain.setValueAtTime(0.12, now); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.frequency.exponentialRampToValueAtTime(400, now+0.12); g.gain.exponentialRampToValueAtTime(0.0001, now+0.18); o.stop(now+0.18); } else if(type==='double'){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(1200, now); g.gain.setValueAtTime(0.1, now); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.frequency.exponentialRampToValueAtTime(700, now+0.16); g.gain.exponentialRampToValueAtTime(0.0001, now+0.22); o.stop(now+0.22); } else if(type==='hit'){ const b=audioCtx.createBufferSource(); const g=audioCtx.createGain(); const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate*0.08, audioCtx.sampleRate); const data = buffer.getChannelData(0); for(let i=0;i<data.length;i++) data[i] = (Math.random()*2-1)*Math.exp(-i/2000); b.buffer=buffer; g.gain.value=0.15; b.connect(g); g.connect(audioCtx.destination); b.start(); } else if(type==='power'){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sawtooth'; o.frequency.setValueAtTime(1400, now); g.gain.setValueAtTime(0.08, now); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.frequency.exponentialRampToValueAtTime(900, now+0.25); g.gain.exponentialRampToValueAtTime(0.0001, now+0.3); o.stop(now+0.3); } else if(type==='gameover'){ const o=audioCtx.createOscillator(); const g=audioCtx.createGain(); o.type='sine'; o.frequency.setValueAtTime(220, now); g.gain.setValueAtTime(0.18, now); o.connect(g); g.connect(audioCtx.destination); o.start(now); o.frequency.exponentialRampToValueAtTime(90, now+0.6); g.gain.exponentialRampToValueAtTime(0.0001, now+0.7); o.stop(now+0.7); } }

    const rand=(a,b)=> Math.random()*(b-a)+a;
    function ensureClouds(){ while(clouds.length<6) clouds.push({x:rand(0,worldWidth()),y:rand(20,110),s:rand(0.6,1.6)}); }
    function worldHeight(){ return canvas.height / devicePixelRatio; }
    function worldWidth(){ return canvas.width / devicePixelRatio; }

    function reset(){ obstacles=[]; powerUps=[]; particles=[]; clouds=[]; spawnTimer=0; speed=420; difficulty=1; score=0; shield=0; rainbow=0; energy=100; health=3; dino.y = worldHeight() - groundY - dino.h; dino.vy=0; dino.onGround=true; dino.duck=false; dino.jumps=0; lastTime = performance.now(); ensureClouds(); updateEnergy(); renderHearts(); }

    function start(){ if(audioCtx && audioCtx.state === 'suspended') audioCtx.resume(); if(audioCtx && !musicStarted && !muted) startProceduralMusic(); reset(); running=true; paused=false; lastTime=performance.now(); loop(lastTime); }
    pauseBtn.addEventListener('click', ()=>{ if(!running) return; paused = !paused; pauseBtn.textContent = paused? 'Resume' : 'Pause'; if(!paused){ lastTime = performance.now(); loop(lastTime); } });
    startBtn.addEventListener('click', ()=>{ // user must be logged in or guest variable set
      if(!window.PLAYER){ alert('Login dulu untuk mulai bermain.'); return; }
      start(); });

    muteBtn.addEventListener('click', ()=>{ muted = !muted; muteBtn.textContent = muted? 'Unmute' : 'Mute'; if(muted) stopProceduralMusic(); else if(!musicStarted) startProceduralMusic(); });

    window.addEventListener('keydown', (e)=>{ if(e.code==='Space' || e.code==='ArrowUp'){ e.preventDefault(); handleJump(); } if(e.code==='ArrowDown'){ e.preventDefault(); dino.duck = true; } if(e.code==='KeyP'){ paused = !paused; } });
    window.addEventListener('keyup', (e)=>{ if(e.code==='ArrowDown') dino.duck = false; });
    canvas.addEventListener('touchstart', (e)=>{ e.preventDefault(); if(!running) start(); else handleJump(); });

    function handleJump(){ if(!running){ if(window.PLAYER) start(); else alert('Login dulu.'); return; } if(dino.jumps < maxJumps && energy >= 6){ dino.vy = -700; dino.onGround=false; dino.jumps++; if(dino.jumps===1) sfx('jump'); else sfx('double'); energy = Math.max(0, energy - 18); updateEnergy(); } }

    function updateEnergy(){ energy = Math.max(0, Math.min(100, energy)); energyFill.style.width = energy + '%'; }
    function renderHearts(){ heartsEl.innerHTML=''; for(let i=0;i<health;i++){ const s = document.createElement('div'); s.textContent='❤️'; heartsEl.appendChild(s); } }

    function spawnObstacle(){ const w=worldWidth(); const kinds=['cactus','cactus2','double','ptero','pit','moving']; const weights=[30,18,12,20,8,12]; let r=Math.random()*weights.reduce((a,b)=>a+b,0), i=0; while(r>0) r-=weights[i++]; const kind=kinds[Math.max(0,i-1)]; const baseY = worldHeight() - groundY; if(kind==='pit'){ obstacles.push({type:'pit',x:w+40,w:rand(80,160),y:baseY}); } else if(kind==='ptero'){ obstacles.push({type:'ptero',x:w+40,y:baseY - rand(70,140),w:48,h:36,vy:0}); } else if(kind==='moving'){ obstacles.push({type:'moving',x:w+40,y:baseY-40,w:48,h:48,dir:Math.random()>0.5?1:-1,vy:0}); } else if(kind==='double'){ const gap=rand(50,90); obstacles.push({type:'cactus',x:w+40,y:baseY,w:36,h:44}); obstacles.push({type:'cactus',x:w+40+gap,y:baseY,w:36,h:44}); } else if(kind==='cactus2'){ obstacles.push({type:'cactus2',x:w+40,y:baseY,w:64,h:64}); } else { obstacles.push({type:'cactus',x:w+40,y:baseY,w:36,h:44}); } }
    function spawnPowerUp(){ const w=worldWidth(); const kind = Math.random()>0.5? 'shield' : 'rainbow'; powerUps.push({type:kind,x:w+40,y:worldHeight()-groundY-80,w:36,h:36}); }
    function coll(a,b){ return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + (b.h||0) && a.y + a.h > b.y; }

    function loop(t){ if(!running) return; if(paused) return; const dt=Math.min(0.05,(t-lastTime)/1000); lastTime=t; score += dt*10*difficulty; speed += dt*4*difficulty; difficulty += dt*0.01; spawnTimer -= dt; if(spawnTimer<=0){ spawnObstacle(); if(Math.random()<0.12) spawnPowerUp(); spawnTimer = rand(0.9,1.6)/Math.min(1 + difficulty*0.05,3); }
      if(dino.onGround) energy = Math.min(100, energy + dt*10); updateEnergy(); if(!dino.onGround){ dino.vy += GRAV*dt; dino.y += dino.vy*dt; } if(dino.y >= worldHeight() - groundY - dino.h){ dino.y = worldHeight() - groundY - dino.h; dino.onGround = true; dino.vy = 0; dino.jumps = 0; } dino.h = dino.duck?30:48;

      for(let i=obstacles.length-1;i>=0;i--){ const o=obstacles[i]; if(o.type==='ptero'){ o.x -= (speed + 60)*dt; o.y += Math.sin((t+i)*0.004)*8*dt*60; } else if(o.type==='moving'){ o.x -= (speed - 40)*dt; o.y += Math.sin((t+i)*0.002)*12*dt*60; } else o.x -= speed*dt; if(o.x + (o.w||0) < -200) obstacles.splice(i,1); else { const box={x:o.x,y:o.y - (o.h||0),w:o.w||40,h:o.h||40}; const dbox={x:dino.x,y:dino.y,w:dino.w,h:dino.h}; if(o.type==='pit'){ if(dbox.x + dbox.w > o.x && dbox.x < o.x + o.w){ if(dino.onGround){ hitPlayer(); return; } } } else if(coll(dbox,box)){ if(shield>0){ shield=0; obstacles.splice(i,1); sfx('power'); createParticles(dbox.x + dbox.w/2, dbox.y + dbox.h/2); } else { hitPlayer(); return; } } } }

      for(let i=powerUps.length-1;i>=0;i--){ const p=powerUps[i]; p.x -= speed*dt; if(p.x + p.w < -100) powerUps.splice(i,1); else if(coll({x:dino.x,y:dino.y,w:dino.w,h:dino.h}, p)){ if(p.type==='shield'){ shield=6; sfx('power'); } else if(p.type==='rainbow'){ rainbow=5; speed *= 1.25; sfx('power'); setTimeout(()=> speed /= 1.25, 5000); } powerUps.splice(i,1); } }

      for(let i=particles.length-1;i>=0;i--){ const P=particles[i]; P.x += P.vx*dt; P.y += P.vy*dt; P.vy += 600*dt; P.life -= dt; if(P.life<=0) particles.splice(i,1); }
      for(const c of clouds){ c.x -= (20 + difficulty*4) * dt * c.s; if(c.x < -200){ c.x = worldWidth() + rand(0,200); c.y = rand(20,110); } }

      drawScene(); scoreEl.textContent = Math.floor(score); if(Math.floor(score) > high){ high = Math.floor(score); highEl.textContent = high; localStorage.setItem('dino_high', high); }
      requestAnimationFrame(loop);
    }

    function hitPlayer(){ if(shield>0){ shield=0; sfx('power'); return; } health -= 1; renderHearts(); sfx('hit'); createExplosion(dino.x + dino.w/2, dino.y + dino.h/2); if(health <= 0){ gameOver(); } }
    function gameOver(){ running=false; sfx('gameover'); createExplosion(dino.x + dino.w/2, dino.y + dino.h/2); drawGameOver(); addLocalScore(); fetchLeaderboard(); stopProceduralMusic(); }

    function addLocalScore(){ const name = (window.PLAYER && window.PLAYER.displayName) || localStorage.getItem('playerName') || 'Anon'; const sc = Math.floor(score); // keep local board as backup
      const board = JSON.parse(localStorage.getItem('dino_local_board')||'[]'); board.push({name,score:sc,date:new Date().toISOString()}); board.sort((a,b)=>b.score-a.score); localStorage.setItem('dino_local_board', JSON.stringify(board.slice(0,50))); }

    function createParticles(x,y){ for(let i=0;i<12;i++) particles.push({x,y,vx:rand(-200,200),vy:rand(-300,-40),life:rand(0.4,1.2)}) }
    function createExplosion(x,y){ for(let i=0;i<30;i++) particles.push({x,y,vx:rand(-400,400),vy:rand(-800,-80),life:rand(0.6,1.6)}) }

    function drawScene(){ const W=worldWidth(), H=worldHeight(); if(rainbow>0){ const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#ff9a9e'); g.addColorStop(0.5,'#fad0c4'); g.addColorStop(1,'#fbc2eb'); ctx.fillStyle = g; } else { const g=ctx.createLinearGradient(0,0,0,H); g.addColorStop(0,'#071029'); g.addColorStop(1,'#052034'); ctx.fillStyle = g; } ctx.fillRect(0,0,W,H);
      ctx.beginPath(); ctx.arc(W - 120,60,36,0,Math.PI*2); ctx.fillStyle = 'rgba(124,92,255,0.12)'; ctx.fill(); for(const c of clouds) drawCloud(c.x,c.y,c.s); const groundTop = H - groundY; for(let i=0;i<Math.ceil(W/40)+2;i++){ ctx.fillStyle = i%2? 'rgba(14,30,45,0.8)' : 'rgba(8,18,30,0.75)'; ctx.fillRect(i*40 - (performance.now()*0.02 % 40), groundTop,40,groundY); }
      for(const p of powerUps){ ctx.save(); ctx.translate(p.x,p.y); ctx.fillStyle = p.type==='shield'? 'rgba(80,200,240,0.95)' : 'rgba(255,120,200,0.95)'; roundRect(ctx,0,0,p.w,p.h,8,true,false); ctx.fillStyle='#06202a'; ctx.font='12px sans-serif'; ctx.fillText(p.type==='shield'?'S':'R',8,22); ctx.restore(); }
      for(const o of obstacles){ ctx.save(); if(o.type==='ptero'){ ctx.translate(o.x,o.y); ctx.beginPath(); ctx.moveTo(0,10); ctx.quadraticCurveTo(20,-20,48,10); ctx.quadraticCurveTo(30,0,0,10); ctx.fillStyle='#8b5cf6'; ctx.fill(); ctx.fillStyle='#ffd100'; ctx.fillRect(6,8,12,6);} else if(o.type==='pit'){ ctx.fillStyle='#021426'; ctx.fillRect(o.x, groundTop, o.w, groundY);} else if(o.type==='moving'){ ctx.fillStyle='#0f9d58'; roundRect(ctx,o.x,o.y,o.w,o.h,6,true,false);} else if(o.type==='cactus2'){ ctx.fillStyle='#1b9b3a'; roundRect(ctx,o.x,o.y - o.h,o.w,o.h,6,true,false);} else { ctx.fillStyle='#0b7a2a'; roundRect(ctx,o.x,o.y - o.h,o.w,o.h,6,true,false);} ctx.restore(); }
      ctx.save(); const dcol = rainbow>0 ? ['#ff5e7e','#ffb86b','#8aedc5','#7aa2ff'][Math.floor(performance.now()/200)%4] : '#cfe6ff'; ctx.fillStyle = dcol; roundRect(ctx, dino.x, dino.y, dino.w, dino.h, 10, true, false); ctx.fillStyle = '#021426'; ctx.fillRect(dino.x + dino.w - 18, dino.y + 8, 6,6); ctx.restore(); if(shield>0){ ctx.beginPath(); ctx.arc(dino.x + dino.w/2, dino.y + dino.h/2, Math.max(dino.w,dino.h),0,Math.PI*2); ctx.fillStyle='rgba(80,200,240,0.12)'; ctx.fill(); } for(const p of particles){ ctx.fillStyle='rgba(255,255,255,0.65)'; ctx.fillRect(p.x,p.y,3,3); } }
    function drawCloud(x,y,s){ ctx.save(); ctx.globalAlpha=0.95; ctx.beginPath(); ctx.ellipse(x,y,40*s,24*s,0,0,Math.PI*2); ctx.ellipse(x+36*s,y+6*s,30*s,16*s,0,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.03)'; ctx.fill(); ctx.restore(); }
    function drawGameOver(){ const W=worldWidth(), H=worldHeight(); ctx.save(); ctx.fillStyle='rgba(0,0,0,0.45)'; ctx.fillRect(0,0,W,H); ctx.fillStyle='#fff'; ctx.font='32px sans-serif'; ctx.textAlign='center'; ctx.fillText('Game Over', W/2, H/2 - 20); ctx.font='18px sans-serif'; ctx.fillText('Score: ' + Math.floor(score) + ' — Tekan Start untuk main lagi', W/2, H/2 + 14); ctx.restore(); }
    function roundRect(ctx,x,y,w,h,r,fill,stroke){ if(typeof r==='undefined') r=5; ctx.beginPath(); ctx.moveTo(x+r,y); ctx.arcTo(x+w,y,x+w,y+h,r); ctx.arcTo(x+w,y+h,x,y+h,r); ctx.arcTo(x,y+h,x,y,r); ctx.arcTo(x,y,x+w,y,r); ctx.closePath(); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }

    // Leaderboard fetch on load for guests as well (read allowed by rules)
    fetchLeaderboard();

    // Expose GAME + PLAYER
    window.GAME = { score: 0 };
    // ensure interactions start audio (browser gesture)
    ['keydown','touchstart','click'].forEach(ev=> window.addEventListener(ev, ()=>{ if(audioCtx && !musicStarted && !muted) startProceduralMusic(); }, {once:true}));

  </script>
</body>
</html>

